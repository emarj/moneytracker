<!DOCTYPE html>
<html>

<head>
  <meta charset="utf-8">
  <style>
    table,
    th,
    td {
      border: 1px solid;
    }

    table {
      margin-top: 3em;
    }
  </style>
</head>

<body>
  <input type="text" id="url" placeholder="/api/whatever" />
  <button id="getbtn">GET</button>
  Refresh <input type="checkbox" id="refresh"> every <input type="number" id="interval" value="1" min="0" step="0.5"> s

  <div id="error"></div>

  <table id="table">

  </table>

  <table id="json">

  </table>

  <script>
    let interval

    const urlEl = document.getElementById('url');
    const btnEl = document.getElementById('getbtn');
    const refreshEl = document.getElementById('refresh');
    const intervalEl = document.getElementById('interval');
    const errorEl = document.getElementById('error');
    const tableEl = document.getElementById('table');
    const jsonEl = document.getElementById('json');

    btnEl.addEventListener('click', action);
    urlEl.addEventListener('change', action);
    refreshEl.addEventListener('click', setupRefresh);
    intervalEl.addEventListener('change', setupRefresh);


    function action() {
      setupRefresh();
      getData(urlEl.value);
    }

    function setupRefresh() {
      console.log("clearing interval...")
      clearInterval(interval)

      if (refreshEl.checked && intervalEl.value > 0) {
        console.log(`setting interval to ${intervalEl.value}s`)
        interval = window.setInterval(getData, intervalEl.value * 1000, urlEl.value)
      }
    }

    function getData(url) {
      console.log("retrieving data...")

      fetch(window.location.origin + url, {
        method: 'GET',
      })
        .then(response => {
          if (!response.ok) {
            throw new Error("HTTP status " + response.status);
          }
          return response.json()
        }).then(data => {

          let table = ''
          let json = ''

          if (Array.isArray(data)) {
            data.forEach((el, k) => {
              
              json = JSON.stringify(data);

              if (k == 0) {
                table += '<thead><tr>'
                for (let [key, value] of Object.entries(el)) {
                  table += `<th>${key}</th>`
                }
                table += '</tr></thead>'
              }

              table += '<tbody><tr>'
              for (let [key, value] of Object.entries(el)) {
                table += `<td>${value}</td>`
              }

              table += '</tr></tbody>'

            });
          } else {
            json = JSON.stringify(data);
          }

          tableEl.innerHTML = table;
          jsonEl.innerHTML = json;

        })
        .catch((error) => {
          errorEl.innerText = error;
        });
    }
  </script>
</body>

</html>